#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged files
echo "${YELLOW}ğŸ“ Getting staged files...${NC}"
files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E "\.(js|jsx|ts|tsx|css|scss|json|html|md)$" || true)

# Run Prettier on staged files
if [ -n "$files" ]; then
  echo "${YELLOW}ğŸ¨ Running Prettier on staged files...${NC}"
  if ! npx prettier --write $files; then
    echo "${RED}âŒ Prettier formatting failed. Please fix the formatting issues.${NC}"
    exit 1
  fi
  echo "${GREEN}âœ… Prettier formatting completed${NC}"

  # Stage the formatted files
  echo "${YELLOW}ğŸ“¨ Staging formatted files...${NC}"
  git add $files
fi

# Check for TypeScript files in client directory
ts_files=$(echo "$files" | grep -E "client/.*\.(ts|tsx)$" || true)
if [ -n "$ts_files" ]; then
  echo "${YELLOW}ğŸ” Running type check on staged TypeScript files...${NC}"
  if ! npx tsc --noEmit --project client/tsconfig.json; then
    echo "${RED}âŒ Type check failed. Please fix the TypeScript errors in client files.${NC}"
    exit 1
  fi
  echo "${GREEN}âœ… Type check passed${NC}"
fi

echo "${GREEN}âœ¨ Pre-commit checks passed!${NC}"
