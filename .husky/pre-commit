#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# Function to display step status
step_status() {
  if [ $? -eq 0 ]; then
    echo "✅ $1 passed"
  else
    echo "❌ $1 failed"
    echo "💡 $2"
    exit 1
  fi
}

# Run Python code formatting checks
echo "🐍 Checking Python files..."
git diff --cached --name-only | grep -E '\.py$' | while read file; do
  if [ -f "$file" ]; then
    echo "Checking $file"
    black --check "$file"
    step_status "Black formatting" "Run 'black $file' to fix formatting issues"
    
    flake8 "$file"
    step_status "Flake8 linting" "Fix the style issues reported by flake8"
  fi
done

# Run prettier, eslint, and tests through lint-staged
echo "🎨 Running code quality checks..."
npx lint-staged
step_status "Code quality checks" "Fix the style issues and ensure all tests pass for modified files"

# Type checking
echo "📝 Running type checking..."
npm run check
step_status "Type checking" "Fix type errors before committing"

# Run quick tests for affected files
echo "🧪 Running tests for changed files..."
git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs -I {} jest --findRelatedTests --passWithNoTests --verbose {}
step_status "Tests" "Ensure all tests pass for the changed files"

# Success message with helpful information
echo "
✨ All pre-commit checks passed! 
   Your code meets our quality standards.

💡 Remember:
   - Write tests for new features
   - Update documentation if needed
   - Break down large changes into smaller commits
"
